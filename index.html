<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Pro | Dashboard Dinâmico</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --sidebar-width: 280px; --primary: #2563eb; --dark-navy: #0f172a; }
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; overflow-x: hidden; transition: 0.3s; }
        #sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: var(--dark-navy); color: white; z-index: 1050; transition: 0.3s; }
        #sidebar.collapsed { width: 80px; }
        #sidebar.collapsed .sidebar-text, #sidebar.collapsed .footer-text { display: none; }
        .main-content { margin-left: var(--sidebar-width); padding: 2rem; min-height: 100vh; display: flex; flex-direction: column; transition: 0.3s; }
        .main-content.expanded { margin-left: 80px; }
        .card-stat { background: white; border-radius: 20px; border: none; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .chart-card { background: white; border-radius: 24px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; }
        .chart-container { height: 650px; position: relative; margin-top: 1rem; }
        .nav-link-custom { color: #94a3b8; padding: 12px 20px; border-radius: 12px; margin: 4px 15px; cursor: pointer; border: none; background: none; text-align: left; width: calc(100% - 30px); display: block; text-decoration: none; transition: 0.2s; }
        .nav-link-custom.active, .nav-link-custom:hover { background: rgba(255,255,255,0.1); color: white; }
        .toggle-btn { background: none; border: none; color: white; padding: 20px; width: 100%; text-align: left; cursor: pointer; outline: none !important; }
        .filter-select { border-radius: 12px; padding: 10px 20px; font-weight: 600; min-width: 400px; border: 2px solid var(--primary); }
        .btn-download { position: absolute; top: 15px; right: 15px; z-index: 10; border-radius: 8px; font-size: 0.8rem; }
        footer { margin-top: auto; padding: 2rem 0; text-align: center; color: #64748b; font-size: 0.9rem; border-top: 1px solid #e2e8f0; }
        .tab-content > .tab-pane { display: block; height: 0; overflow: hidden; }
        .tab-content > .active { height: auto; overflow: visible; }
        .table-custom { font-size: 0.9rem; border-radius: 12px; overflow: hidden; }
        .table-custom thead { background: var(--dark-navy); color: white; }
    </style>
</head>
<body>

    <aside id="sidebar">
        <div class="p-4 d-flex align-items-center gap-3">
            <i class="fas fa-chart-line fa-2x text-primary"></i>
            <span class="fs-4 fw-bold sidebar-text">Analytics Pro</span>
        </div>
        <nav class="nav flex-column mt-3">
            <a href="#" class="nav-link-custom active"><i class="fas fa-house me-3"></i> <span class="sidebar-text">Dashboard</span></a>
            <button class="nav-link-custom" onclick="window.location.reload()"><i class="fas fa-sync-alt me-3"></i> <span class="sidebar-text">Atualizar Dados</span></button>
        </nav>
        <button class="toggle-btn position-absolute bottom-0" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i> <span class="sidebar-text ms-3">Recolher Menu</span>
        </button>
    </aside>

    <main class="main-content" id="main-content">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-0">Resultados da Pesquisa</h2>
                <p class="text-muted mb-0">Escala Likert & Análise de Consistência</p>
            </div>
            <select id="themeFilter" class="form-select filter-select" onchange="applyFilter()"></select>
        </header>

        <div class="row g-4 mb-5">
            <div class="col-md-4"><div class="card card-stat p-4 text-center"><small class="text-muted fw-bold">RESPOSTAS (N)</small><h2 id="valN" class="display-5 fw-bold">0</h2></div></div>
            <div class="col-md-4"><div class="card card-stat p-4 text-center"><small class="text-muted fw-bold">ALFA DE CRONBACH</small><h2 id="valAlpha" class="display-5 fw-bold text-danger">0.00</h2></div></div>
            <div class="col-md-4"><div class="card card-stat p-4 text-center"><small class="text-muted fw-bold">MÉDIA GLOBAL</small><h2 id="valMean" class="display-5 fw-bold text-success">0.00</h2></div></div>
        </div>

        <ul class="nav nav-pills mb-4 gap-2" id="dashboardTabs">
            <li class="nav-item"><button class="nav-link active shadow-sm" data-bs-toggle="pill" data-bs-target="#tab-full">Divergente Detalhado</button></li>
            <li class="nav-item"><button class="nav-link shadow-sm" data-bs-toggle="pill" data-bs-target="#tab-simp">Divergente Simplificado</button></li>
            <li class="nav-item"><button class="nav-link shadow-sm" data-bs-toggle="pill" data-bs-target="#tab-bar">Barras Acumuladas</button></li>
            <li class="nav-item"><button class="nav-link shadow-sm" data-bs-toggle="pill" data-bs-target="#tab-rel">Relatórios e Eixos</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-full">
                <div class="chart-card" id="card-full">
                    <button class="btn btn-sm btn-outline-secondary btn-download" onclick="downloadPNG('card-full', 'Divergente_Detalhado')"><i class="fas fa-camera me-1"></i> PNG</button>
                    <div class="chart-container"><canvas id="chartFull"></canvas></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-simp">
                <div class="chart-card" id="card-simp">
                    <button class="btn btn-sm btn-outline-secondary btn-download" onclick="downloadPNG('card-simp', 'Divergente_Simplificado')"><i class="fas fa-camera me-1"></i> PNG</button>
                    <div class="chart-container"><canvas id="chartSimp"></canvas></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-bar">
                <div class="chart-card" id="card-bar">
                    <button class="btn btn-sm btn-outline-secondary btn-download" onclick="downloadPNG('card-bar', 'Barras_Acumuladas')"><i class="fas fa-camera me-1"></i> PNG</button>
                    <div class="chart-container"><canvas id="chartBar"></canvas></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-rel">
                <div class="chart-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold m-0">Estatísticas por Eixo e Item</h5>
                        <button class="btn btn-dark btn-sm" onclick="exportPDF()"><i class="fas fa-file-pdf me-1"></i> Baixar Relatório PDF</button>
                    </div>
                    
                    <h6 class="text-primary fw-bold mt-4">Resumo dos Eixos</h6>
                    <table class="table table-custom mb-5" id="table-eixos">
                        <thead><tr><th>Eixo</th><th>Tema</th><th>Alfa</th><th>Média</th></tr></thead>
                        <tbody id="body-eixos"></tbody>
                    </table>

                    <h6 class="text-primary fw-bold">Detalhamento por Questão</h6>
                    <table class="table table-custom" id="table-itens">
                        <thead><tr><th>ID</th><th>Questão</th><th>Média</th><th>Desvio Padrão</th></tr></thead>
                        <tbody id="body-itens"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            <div class="container">
                <p class="mb-1"><b>Analytics Pro Dashboard</b> - Sistema de Monitoramento Educacional</p>
                <p class="text-muted small mb-0">Gerado automaticamente via JSON | v3.0 - 2026</p>
            </div>
        </footer>
    </main>

    <script>
        Chart.register(ChartDataLabels);
        let charts = {};
        let rawData = { analise: [], categ: [], itens: {} };

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('main-content').classList.toggle('expanded');
            setTimeout(() => { Object.values(charts).forEach(c => c.resize()); }, 350);
        }

        async function loadData() {
            try {
                const [resC, resI, resA] = await Promise.all([fetch('categ3.json'), fetch('itens3.json'), fetch('analise3.json')]);
                const categ = await resC.json(); const itens = await resI.json(); const analise = await resA.json();
                rawData.categ = categ;
                rawData.analise = analise;
                itens.forEach(it => rawData.itens[String(parseInt(it.item))] = it.texto);
                const f = document.getElementById('themeFilter');
                f.innerHTML = '<option value="ALL">TODOS OS EIXOS DA PESQUISA</option>';
                categ.forEach(c => f.innerHTML += `<option value="${c.Eixo}">${c.Eixo} - ${c.Tema}</option>`);
                processar(analise);
            } catch (e) {
                console.error("Erro ao carregar JSONs.");
            }
        }

        function processar(data, keys = null) {
            const nK = (k) => String(parseInt(k));
            const activeKeys = keys || Object.keys(data[0]).filter(k => !isNaN(parseInt(k))).map(nK);
            const N = data.length;
            let sumG = 0, countG = 0;
            const stats = activeKeys.map(k => {
                let f = {1:0, 2:0, 3:0, 4:0, 5:0}, vls = [];
                data.forEach(r => {
                    const v = parseInt(r[k]);
                    if(f[v] !== undefined) { f[v]++; sumG += v; countG++; vls.push(v); }
                });
                const m = vls.reduce((a,b)=>a+b,0)/vls.length;
                const dp = Math.sqrt(vls.reduce((a,b)=>a+Math.pow(b-m,2),0)/vls.length);
                return {
                    id: k, texto: rawData.itens[k] || `Questão ${k}`,
                    dt: (f[1]/N*100).toFixed(1), d: (f[2]/N*100).toFixed(1), n: (f[3]/N*100).toFixed(1),
                    c: (f[4]/N*100).toFixed(1), ct: (f[5]/N*100).toFixed(1),
                    neg: ((f[1]+f[2])/N*100).toFixed(1), pos: ((f[4]+f[5])/N*100).toFixed(1),
                    media: m.toFixed(2), dp: dp.toFixed(2)
                };
            });
            document.getElementById('valN').innerText = N;
            document.getElementById('valAlpha').innerText = calculateAlpha(data, activeKeys);
            document.getElementById('valMean').innerText = (sumG/countG || 0).toFixed(2);
            renderCharts(stats);
            renderTables(data, stats);
        }

        function calculateAlpha(data, keys) {
            if(keys.length <= 1) return "0.00";
            const k = keys.length;
            const itemVars = keys.map(key => {
                const vals = data.map(r => parseFloat(r[key])).filter(v => !isNaN(v));
                const m = vals.reduce((a,b)=>a+b,0)/vals.length;
                return vals.reduce((a,b)=>a+Math.pow(b-m,2),0)/vals.length;
            });
            const totals = data.map(r => keys.reduce((s,k) => s + (parseFloat(r[k])||0),0));
            const tMean = totals.reduce((a,b)=>a+b,0)/totals.length;
            const tVar = totals.reduce((a,b)=>a+Math.pow(b-tMean,2),0)/totals.length;
            return tVar === 0 ? "0.00" : ((k/(k-1))*(1-(itemVars.reduce((a,b)=>a+b,0)/tVar))).toFixed(2);
        }

        function renderCharts(stats) {
            const colors = ['#dc2626', '#f87171', '#e2e8f0', '#60a5fa', '#2563eb'];
            const labels = stats.map(s => s.texto);
            const ctx = (id) => { if(charts[id]) charts[id].destroy(); return document.getElementById(id).getContext('2d'); };
            
            const commonOpt = { 
                indexAxis: 'y', maintainAspectRatio: false, 
                plugins: { 
                    datalabels: { 
                        // Alteração: Apenas o Neutro (datasetIndex 2) é preto. 
                        // Discordo Total (0) e Discordo (1) agora são brancos.
                        color: (c) => c.datasetIndex === 2 ? '#000' : '#fff',
                        formatter: v => v === 0 ? '' : Math.abs(v)+'%' 
                    } 
                }, 
                scales: { 
                    x: { stacked: true, grid: {display: false}, ticks: {callback: v => Math.abs(v)+'%'} }, 
                    y: { stacked: true, grid: {display: false} } 
                } 
            };

            charts.chartFull = new Chart(ctx('chartFull'), { type: 'bar', data: { labels, datasets: [
                { label: 'Discordo Total', data: stats.map(s => -s.dt), backgroundColor: colors[0] },
                { label: 'Discordo', data: stats.map(s => -s.d), backgroundColor: colors[1] },
                { label: 'Neutro', data: stats.map(s => s.n), backgroundColor: colors[2] },
                { label: 'Concordo', data: stats.map(s => s.c), backgroundColor: colors[3] },
                { label: 'Concordo Total', data: stats.map(s => s.ct), backgroundColor: colors[4] }
            ]}, options: commonOpt });

            charts.chartSimp = new Chart(ctx('chartSimp'), { type: 'bar', data: { labels, datasets: [
                { label: 'Negativo', data: stats.map(s => -s.neg), backgroundColor: colors[0] },
                { label: 'Neutro', data: stats.map(s => s.n), backgroundColor: colors[2] },
                { label: 'Positivo', data: stats.map(s => s.pos), backgroundColor: colors[4] }
            ]}, options: commonOpt });

            charts.chartBar = new Chart(ctx('chartBar'), { type: 'bar', data: { labels, datasets: [
                { label: 'D. Total', data: stats.map(s => s.dt), backgroundColor: colors[0] },
                { label: 'Discordo', data: stats.map(s => s.d), backgroundColor: colors[1] },
                { label: 'Neutro', data: stats.map(s => s.n), backgroundColor: colors[2] },
                { label: 'Concordo', data: stats.map(s => s.c), backgroundColor: colors[3] },
                { label: 'C. Total', data: stats.map(s => s.ct), backgroundColor: colors[4] }
            ]}, options: { ...commonOpt, indexAxis: 'x', scales: { x: {stacked: true}, y: {stacked: true, max: 100, ticks: {callback: v => v + '%'}} } } });
        }

        function renderTables(data, stats) {
            const bE = document.getElementById('body-eixos'); bE.innerHTML = '';
            rawData.categ.forEach(c => {
                const ks = c.Questões.split(',').map(s => String(parseInt(s.trim())));
                const vls = [];
                data.forEach(r => ks.forEach(k => { if(r[k]) vls.push(parseInt(r[k])); }));
                const m = vls.length ? (vls.reduce((a,b)=>a+b,0)/vls.length).toFixed(2) : "0.00";
                bE.innerHTML += `<tr><td>${c.Eixo}</td><td>${c.Tema}</td><td class="fw-bold">${calculateAlpha(data, ks)}</td><td>${m}</td></tr>`;
            });
            const bI = document.getElementById('body-itens'); bI.innerHTML = '';
            stats.forEach(s => {
                bI.innerHTML += `<tr><td>${s.id}</td><td class="small">${s.texto}</td><td>${s.media}</td><td>${s.dp}</td></tr>`;
            });
        }

        function applyFilter() {
            const v = document.getElementById('themeFilter').value;
            if(v === 'ALL') processar(rawData.analise);
            else {
                const c = rawData.categ.find(x => x.Eixo === v);
                processar(rawData.analise, c.Questões.split(',').map(s => String(parseInt(s.trim()))));
            }
        }

        async function downloadPNG(id, name) {
            const canvas = await html2canvas(document.getElementById(id));
            const link = document.createElement('a');
            link.download = `${name}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Relatório Analytics Pro - Análise de Eixos", 14, 15);
            doc.autoTable({ html: '#table-eixos', startY: 20, headStyles: {fillColor: [15, 23, 42]} });
            doc.addPage();
            doc.text("Detalhamento por Item", 14, 15);
            doc.autoTable({ html: '#table-itens', startY: 20, headStyles: {fillColor: [15, 23, 42]} });
            doc.save("Relatorio_Completo.pdf");
        }
        window.onload = loadData;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
